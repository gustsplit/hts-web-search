<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>US HTS Code Finder (PoC)</title>
  <style>
    :root {
      --primary: #3182f6;
      --primary-dark: #2563d9;
      --bg: #f5f7fb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border-soft: #d1d5db;
      --card-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.06);
      padding: 24px 28px 28px;
      margin-bottom: 18px;
    }

    .app-header {
      margin-bottom: 18px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--primary);
    }

    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-sub);
    }

    /* Form */

    form {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
      margin-top: 10px;
      margin-bottom: 22px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    input,
    textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
      background: #f9fafb;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(49, 130, 246, 0.35);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
      max-height: 200px;
      line-height: 1.4;
    }

    .form-row-inline {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
    }

    .button-row {
      margin-top: 4px;
    }

    button {
      padding: 9px 20px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(49, 130, 246, 0.35);
      transition: background-color 0.15s ease, box-shadow 0.15s ease,
        transform 0.05s ease;
    }

    button:hover {
      background: var(--primary-dark);
      box-shadow: 0 14px 30px rgba(37, 99, 217, 0.45);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(37, 99, 217, 0.38);
    }

    .btn-icon {
      font-size: 16px;
    }

    /* Results */

    .results-section-title {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 15px;
      font-weight: 600;
    }

    #results {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-main);
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-sub);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      border-radius: 14px;
      overflow: hidden;
      background: #f9fafb;
    }

    thead {
      background: #eef3ff;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 9px 10px;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
    }

    td {
      font-size: 13px;
      color: #111827;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background: #f3f4ff;
    }

    .error-box {
      background: #fff4f5;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      color: #b91c1c;
      font-size: 12px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #e5f0ff;
      color: #1d4ed8;
      margin-left: 4px;
    }

    /* Duty simulation card */

    .duty-card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .duty-subtitle {
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .duty-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 10px;
    }

    .duty-result {
      font-size: 14px;
      font-weight: 600;
      margin-top: 4px;
    }

    .badge-hts {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #ecfdf5;
      color: #047857;
      margin-left: 4px;
    }

    .muted {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .hidden {
      display: none;
    }

    /* HTS íˆ´íŒ */
    .hts-tooltip {
      position: fixed;
      z-index: 9999;
      background: #111827;
      color: #f9fafb;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 11px;
      max-width: 320px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -8px);
      transition: opacity 0.08s ease;
      white-space: normal;
    }

    .hts-tooltip.visible {
      opacity: 0.97;
    }

    .hts-tooltip table {
      width: 100%;
      border-collapse: collapse;
    }

    .hts-tooltip th,
    .hts-tooltip td {
      padding: 2px 0;
      border: none;
      font-size: 11px;
    }

    .hts-tooltip th {
      color: #9ca3af;
      text-align: left;
    }

    .hts-tooltip td.code {
      font-weight: 600;
      padding-right: 8px;
      white-space: nowrap;
    }

    /* =========================
       ì´ë©”ì¼ Step / ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼
       ========================= */

    .email-card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .email-subtitle {
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    .email-inline-row {
      display: grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    .email-preview-box {
      margin-top: 12px;
      padding: 14px 16px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      color: #111827;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .email-preview-header {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .email-preview-meta {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .badge-step {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #eef3ff;
      color: #1d4ed8;
      margin-left: 4px;
    }

    @media (max-width: 640px) {
      .card {
        padding: 18px 16px 20px;
      }

      .form-row-inline {
        grid-template-columns: 1fr;
      }

      .duty-grid {
        grid-template-columns: 1fr;
      }

      .email-inline-row {
        grid-template-columns: 1fr;
      }

      th,
      td {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- ë©”ì¸ ê²€ìƒ‰ ì¹´ë“œ -->
    <div class="card">
      <header class="app-header">
        <div class="app-title-row">
          <div class="logo-dot"></div>
          <h1>US HTS Code Finder</h1>
        </div>
        <div class="app-subtitle">
          ì…ë ¥í•˜ì‹  ìƒí’ˆ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¯¸êµ­ HTS í›„ë³´ ì½”ë“œë¥¼ ì¶”ì²œí•´ ë“œë ¤ìš”.
        </div>
      </header>

      <form id="hts-form">
        <div>
          <div class="field-label">ì œí’ˆëª… (Product Name)</div>
          <input type="text" id="product_name" placeholder="ì˜ˆ: ì˜¥ìˆ˜ìˆ˜" required />
        </div>

        <div class="form-row-inline">
          <div>
            <div class="field-label">ìˆ˜ì¶œì HS ì½”ë“œ (í•œêµ­, ì„ íƒ)</div>
            <input type="text" id="exporter_hs" placeholder="ì˜ˆ: 1005.90" />
          </div>
          <div>
            <div class="field-label">ì›ì‚°ì§€ (Country of Origin)</div>
            <input type="text" id="country_of_origin" placeholder="ì˜ˆ: Korea" required />
          </div>
        </div>

        <div>
          <div class="field-label">ì œí’ˆ ì„¤ëª… (Product Description)</div>
          <textarea
            id="description"
            rows="4"
            placeholder="ì˜ˆ: ì¡°ë¦¬í•˜ì§€ ì•Šì€ ë‚ ê²ƒì˜ ì‹ìš© ì˜¥ìˆ˜ìˆ˜"
            required
          ></textarea>
        </div>

        <div class="button-row">
          <button type="submit">
            <span class="btn-icon">ğŸ”</span>
            <span>HTS ì½”ë“œ ê²€ìƒ‰í•˜ê¸°</span>
          </button>
        </div>
      </form>

      <div class="results-section-title">
        HTS ì½”ë“œ ì¶”ì²œ ê²°ê³¼
        <span class="badge-pill">LLM ê¸°ë°˜ í›„ë³´ ë¦¬ìŠ¤íŠ¸</span>
      </div>
      <div id="results"></div>
    </div>

    <!-- ê´€ì„¸ ì‹œë®¬ë ˆì´ì…˜ ì¹´ë“œ -->
    <div class="card hidden" id="duty-section">
      <div class="duty-card-title">ì‹¤ì œ ì–¼ë§ˆë‚˜ ê´€ì„¸ê°€ ë‚˜ì˜¬ì§€ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?</div>
      <div class="duty-subtitle">
        ìœ„ì—ì„œ ì„ íƒí•˜ì‹  HTS ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ, ìˆ˜ëŸ‰ê³¼ ë‹¨ê°€(USD)ë¥¼ ì…ë ¥í•´ ì˜ˆìƒ ê´€ì„¸ë¥¼ ê°„ë‹¨íˆ ê³„ì‚°í•´ ë³´ì„¸ìš”.
      </div>

      <div class="muted" id="fx-info">
        í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <div class="muted" id="selected-hts-info">
        ì•„ì§ HTS ì½”ë“œë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ì…¨ì–´ìš”. í‘œì—ì„œ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
      </div>

      <div class="duty-grid">
        <div>
          <div class="field-label">ìˆ˜ëŸ‰</div>
          <input type="number" id="qty" min="1" placeholder="ì˜ˆ: 100" />
        </div>
        <div>
          <div class="field-label">ë‹¨ê°€ (USD $)</div>
          <input type="number" id="unit_price" min="0" step="0.01" placeholder="ì˜ˆ: 50" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button type="button" id="calc-duty-btn">
            <span class="btn-icon">ğŸ“Š</span>
            <span>ê´€ì„¸ ê³„ì‚°í•˜ê¸°</span>
          </button>
        </div>
      </div>

      <div class="duty-result" id="duty-result"></div>
      <div class="muted">
        * ì‹¤ì œ ê´€ì„¸ëŠ” ì„¸ê´€ ì‹ ê³  ë‚´ìš©, FTA, ì¶”ê°€ ì„¸ìœ¨ ë“±ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì´ ê³„ì‚°ì€ ì°¸ê³ ìš© ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤.
      </div>
    </div>

    <!-- ì´ë©”ì¼ Step ì¹´ë“œ (ìƒˆë¡œìš´ Step) -->
    <div class="card hidden" id="email-section">
      <div class="email-card-title">
        US HTS code ë° ê³„ì‚°ëœ ë‚´ìš©ì„ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì‹œê² ì–´ìš”?
        <span class="badge-step">Step 3 Â· Email</span>
      </div>
      <div class="email-subtitle">
        ì§€ê¸ˆê¹Œì§€ ì…ë ¥í•˜ì‹  ìƒí’ˆ ì •ë³´, ì„ íƒí•˜ì‹  HTS ì½”ë“œ, ê·¸ë¦¬ê³  ë°©ê¸ˆ ê³„ì‚°í•œ ê´€ì„¸ ê¸ˆì•¡ì„ í•œ ë²ˆì— ì •ë¦¬í•´ì„œ
        ë©”ì¼ ì´ˆì•ˆìœ¼ë¡œ ë§Œë“¤ì–´ ë“œë ¤ìš”.
      </div>

      <div class="email-inline-row">
        <div>
          <div class="field-label">ì´ë©”ì¼ ì£¼ì†Œ</div>
          <input type="email" id="email_to" placeholder="ì˜ˆ: name@example.com" />
        </div>
        <div>
          <div class="field-label">API Access Token</div>
          <input
            type="password"
            id="email_access_token"
            placeholder="X-Access-Token í—¤ë” ê°’"
            autocomplete="off"
          />
        </div>
        <div>
          <button type="button" id="email-preview-btn">
            <span class="btn-icon">ğŸ“¨</span>
            <span>ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸° ë§Œë“¤ê¸°</span>
          </button>
        </div>
      </div>

      <div class="muted">
        * ì‹¤ì œ ë°œì†¡ ì „ì—, ì•„ë˜ì—ì„œ ë©”ì¼ ë‚´ìš©ì„ ë¨¼ì € í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.
      </div>

      <div id="email-preview" class="email-preview-box hidden">
        <!-- JSì—ì„œ ë‚´ìš© ì±„ì›€ -->
      </div>

      <div style="margin-top:10px;">
        <button type="button" id="email-send-btn" class="hidden">
          <span class="btn-icon">âœ…</span>
          <span>ì´ ë‚´ìš©ìœ¼ë¡œ ì´ë©”ì¼ ë³´ë‚´ê¸°</span>
        </button>
        <div id="email-send-status" class="muted hidden"></div>
      </div>
    </div>
  </div>

  <!-- ë©´ì±… ê³ ì§€ë¬¸ -->
  <div style="font-size:11px; color:#888; margin-top:30px; text-align:center;">
    * ë³¸ ì„œë¹„ìŠ¤ì˜ HTS ì½”ë“œ ë° ê´€ì„¸ìœ¨ì€ ì°¸ê³ ìš©ìœ¼ë¡œ ì œê³µë˜ë©°,
    ì‹¤ì œ ì„¸ìœ¨ ë° ë¶„ë¥˜ëŠ” ë¯¸êµ­ CBP ë° ê´€ì„¸ë‹¹êµ­ì˜ ìµœì¢… ê²°ì •ì— ë”°ë¦…ë‹ˆë‹¤.
    ë³¸ ì •ë³´ì— ê¸°ë°˜í•œ ëª¨ë“  íŒë‹¨ ë° ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.
  </div>

  <!-- HTS ì½”ë“œ êµ¬ì¡° íˆ´íŒ -->
  <div id="hts-tooltip" class="hts-tooltip"></div>

  <script>
    const form = document.getElementById("hts-form");
    const resultsEl = document.getElementById("results");
    const dutySection = document.getElementById("duty-section");
    const selectedInfoEl = document.getElementById("selected-hts-info");
    const dutyResultEl = document.getElementById("duty-result");
    const fxInfoEl = document.getElementById("fx-info");
    const calcBtn = document.getElementById("calc-duty-btn");
    const qtyInput = document.getElementById("qty");
    const unitPriceInput = document.getElementById("unit_price");
    const htsTooltip = document.getElementById("hts-tooltip");

    const emailSection = document.getElementById("email-section");
    const emailToInput = document.getElementById("email_to");
    const emailAccessTokenInput = document.getElementById("email_access_token");
    const emailPreviewBtn = document.getElementById("email-preview-btn");
    const emailPreviewEl = document.getElementById("email-preview");
    const emailSendBtn = document.getElementById("email-send-btn");
    const emailSendStatusEl = document.getElementById("email-send-status");

    // ë§ˆì§€ë§‰ í›„ë³´ë“¤ ì €ì¥ (ë¼ë””ì˜¤ ì„ íƒ ì‹œ ì°¸ì¡°)
    let lastCandidates = [];
    // ì„ íƒëœ í›„ë³´ index
    let lastSelectedIndex = -1;
    // ê´€ì„¸ ê³„ì‚° ê²°ê³¼ ì €ì¥
    let lastDutyCalc = null;
    // USD-KRW í™˜ìœ¨
    let usdKrwRate = null;
    // HTS ì„¤ëª… ìºì‹œ
    const htsExplainCache = {};
    // ë§ˆì§€ë§‰ ì´ë©”ì¼ ì´ˆì•ˆ ì €ì¥ (ë°œì†¡ ì‹œ ì‚¬ìš©)
    let lastEmailDraft = null;

    // ì´ë©”ì¼ í† í° ë¡œë“œ (ìˆìœ¼ë©´ ìë™ ì…ë ¥)
    const savedAccessToken = localStorage.getItem("EMAIL_ACCESS_TOKEN");
    if (savedAccessToken) {
      emailAccessTokenInput.value = savedAccessToken;
    }

    function formatNumber(n) {
      if (isNaN(n)) return "";
      return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    // "0%", "4.5%" ê°™ì€ ë¬¸ìì—´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ ë¹„ìœ¨(0.0~1.0)ë¡œ ë³€í™˜
    function parseRate(rateStr) {
      if (!rateStr) return 0;
      const m = String(rateStr).match(/[\d.]+/);
      if (!m) return 0;
      const v = parseFloat(m[0]);
      if (isNaN(v)) return 0;
      return v / 100.0;
    }

    // ë°±ì—”ë“œì—ì„œ USD-KRW í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
    async function fetchFxRate() {
      try {
        const res = await fetch("http://127.0.0.1:8000/api/exchange-rate/usd-krw");
        const data = await res.json();
        if (data.rate) {
          usdKrwRate = data.rate;
          const ts = data.timestamp ? ` (ì—…ë°ì´íŠ¸: ${new Date(data.timestamp).toLocaleString()})` : "";
          fxInfoEl.textContent =
            `í˜„ì¬ ì ìš© í™˜ìœ¨: 1 USD â‰ˆ ${usdKrwRate.toFixed(2)}ì›${ts}`;
        } else {
          usdKrwRate = null;
          const ts = data.timestamp ? ` (ì—…ë°ì´íŠ¸: ${new Date(data.timestamp).toLocaleString()})` : "";
          fxInfoEl.textContent =
            `í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì„ì‹œë¡œ ì›í™” í™˜ì‚°ì€ í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)${ts}`;
        }
        } catch (err) {
        console.error(err);
        usdKrwRate = null;
        fxInfoEl.textContent =
          "í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì„ì‹œë¡œ ì›í™” í™˜ì‚°ì€ í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
      }
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ í™˜ìœ¨ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
    fetchFxRate();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultsEl.innerHTML =
        '<span class="loading-text">LLMì´ HTS í›„ë³´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>';
      dutyResultEl.textContent = "";
      selectedInfoEl.textContent =
        "ì•„ì§ HTS ì½”ë“œë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ì…¨ì–´ìš”. í‘œì—ì„œ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
      emailSection.classList.add("hidden");
      emailPreviewEl.classList.add("hidden");
      emailPreviewEl.innerHTML = "";
      emailSendBtn.classList.add("hidden");
      emailSendStatusEl.classList.add("hidden");
      emailSendStatusEl.textContent = "";
      lastSelectedIndex = -1;
      lastDutyCalc = null;
      lastEmailDraft = null;

      const payload = {
        product_name: document.getElementById("product_name").value,
        exporter_hs: document.getElementById("exporter_hs").value || null,
        description: document.getElementById("description").value,
        country_of_origin: document.getElementById("country_of_origin").value,
      };

      try {
        const res = await fetch("http://127.0.0.1:8000/api/search_hts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (data.error) {
          resultsEl.innerHTML =
            '<div class="error-box">Error: ' +
            data.error +
            (data.raw ? "\n\nRaw:\n" + data.raw : "") +
            "</div>";
          dutySection.classList.add("hidden");
          return;
        }

        const candidates = data.candidates || [];
        lastCandidates = candidates;

        // í›„ë³´ title/reason í•œêµ­ì–´ ë²ˆì—­
        await translateCandidatesToKorean(lastCandidates);

        if (candidates.length === 0) {
          resultsEl.innerHTML =
            '<span class="loading-text">ì¶”ì²œëœ HTS ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
          dutySection.classList.add("hidden");
          return;
        }

        // í…Œì´ë¸” ìƒì„±
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th>ì„ íƒ</th>
                <th>ì‹ ë¢°ë„</th>
                <th>HTS Code</th>
                <th>í’ˆëª©ëª…</th>
                <th>ê´€ì„¸ìœ¨</th>
                <th>ë¶„ë¥˜ ì„¤ëª…</th>
              </tr>
            </thead>
            <tbody>
        `;

        candidates.forEach((c, idx) => {
          const confText =
            c.confidence !== undefined && c.confidence !== null
              ? `${c.confidence}%`
              : "";
          tableHtml += `
            <tr>
              <td>
                <input type="radio" name="hts_choice" value="${idx}" />
              </td>
              <td>${confText}</td>
              <td class="hts-code-cell" data-hts="${c.hts_code || ""}">
                ${c.hts_code || ""}
              </td>
              <td>${c.title || ""}</td>
              <td>${c.estimated_tariff_rate || ""}</td>
              <td>${c.reason || ""}</td>
            </tr>
          `;
        });

        tableHtml += "</tbody></table>";
        resultsEl.innerHTML = tableHtml;

        // ê´€ì„¸ ì‹œë®¬ë ˆì´ì…˜ UI ë³´ì´ê¸° + ì‚´ì§ ìŠ¤í¬ë¡¤
        dutySection.classList.remove("hidden");
        setTimeout(() => {
          dutySection.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 150);

        // ë¼ë””ì˜¤ ë²„íŠ¼ change í•¸ë“¤ëŸ¬ ë“±ë¡
        document.getElementsByName("hts_choice").forEach((radio) => {
          radio.addEventListener("change", () => {
            const idx = parseInt(radio.value, 10);
            const item = lastCandidates[idx];
            if (!item) return;
            lastSelectedIndex = idx;
            const rateStr = item.estimated_tariff_rate || "N/A";
            selectedInfoEl.innerHTML =
              `ì„ íƒëœ HTS: <strong>${item.hts_code || ""}</strong>` +
              `<span class="badge-hts">ê´€ì„¸ìœ¨: ${rateStr}</span>`;
            dutyResultEl.textContent = "";
            lastDutyCalc = null;
            emailSection.classList.add("hidden");
            emailPreviewEl.classList.add("hidden");
            emailPreviewEl.innerHTML = "";
            emailSendBtn.classList.add("hidden");
            emailSendStatusEl.classList.add("hidden");
            emailSendStatusEl.textContent = "";
            lastEmailDraft = null;
          });
        });

        // HTS ì½”ë“œ ì…€ í˜¸ë²„ í•¸ë“¤ëŸ¬ ì—°ê²°
        attachHTSHoverHandlers();
      } catch (err) {
        console.error(err);
        resultsEl.innerHTML =
          '<div class="error-box">Error: ' + String(err) + "</div>";
        dutySection.classList.add("hidden");
      }
    });

    function buildTooltipHtml(segments) {
      if (!segments || !segments.length) {
        return "ì½”ë“œ êµ¬ì¡° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      }

      let html = `
        <div style="margin-bottom:4px; font-weight:600; font-size:11px;">
          ì½”ë“œ êµ¬ì¡° / ë¶„ë¥˜ ì²´ê³„
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:90px;">ì½”ë“œ êµ¬ì¡°</th>
              <th>ì˜ë¯¸</th>
            </tr>
          </thead>
          <tbody>
      `;

      segments.forEach(seg => {
        html += `
          <tr>
            <td class="code">${seg.code_part || ""}</td>
            <td>${seg.meaning_ko || ""}</td>
          </tr>
        `;
      });

      html += "</tbody></table>";
      return html;
    }

    async function fetchHTSExplain(htsCode) {
      if (!htsCode) return null;

      if (htsExplainCache[htsCode]) {
        return htsExplainCache[htsCode];
      }

      try {
        const res = await fetch("http://127.0.0.1:8000/api/explain_hts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hts_code: htsCode })
        });
        const data = await res.json();
        if (data.error) {
          console.error("explain_hts error:", data.error);
          return null;
        }
        htsExplainCache[htsCode] = data.segments || [];
        return htsExplainCache[htsCode];
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    function attachHTSHoverHandlers() {
      const cells = document.querySelectorAll(".hts-code-cell");

      cells.forEach(cell => {
        const htsCode = cell.getAttribute("data-hts");

        cell.addEventListener("mouseenter", async (e) => {
          if (!htsCode) return;

          htsTooltip.innerHTML = "ì½”ë“œ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
          htsTooltip.classList.add("visible");
          positionTooltip(e);

          const segments = await fetchHTSExplain(htsCode);
          htsTooltip.innerHTML = buildTooltipHtml(segments);
        });

        cell.addEventListener("mousemove", (e) => {
          positionTooltip(e);
        });

        cell.addEventListener("mouseleave", () => {
          htsTooltip.classList.remove("visible");
        });
      });
    }

    function positionTooltip(e) {
      const offsetX = 0;
      const offsetY = -12;
      htsTooltip.style.left = `${e.clientX + offsetX}px`;
      htsTooltip.style.top = `${e.clientY + offsetY}px`;
    }

    async function translateCandidatesToKorean(candidates) {
      if (!candidates || candidates.length === 0) return;

      for (const c of candidates) {
        const textToTranslate = `Title: ${c.title || ""}\nReason: ${c.reason || ""}`;

        try {
          const res = await fetch("http://127.0.0.1:8000/api/translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: textToTranslate }),
          });

          const data = await res.json();
          if (data.translated_text) {
            const lines = data.translated_text
              .split("\n")
              .map((l) => l.trim())
              .filter((l) => l.length > 0);

            const titleLine = lines.find((l) =>
              l.toLowerCase().startsWith("title:")
            );
            const reasonLine = lines.find((l) =>
              l.toLowerCase().startsWith("reason:")
            );

            if (titleLine) {
              c.title = titleLine.replace(/^title:\s*/i, "");
            }
            if (reasonLine) {
              c.reason = reasonLine.replace(/^reason:\s*/i, "");
            }
          }
        } catch (err) {
          console.error("Translation error:", err);
        }
      }
    }

    calcBtn.addEventListener("click", () => {
      const radios = document.getElementsByName("hts_choice");
      let selectedIndex = -1;
      radios.forEach((r) => {
        if (r.checked) selectedIndex = parseInt(r.value, 10);
      });

      if (selectedIndex < 0) {
        alert("ë¨¼ì € í‘œì—ì„œ HTS ì½”ë“œë¥¼ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      const qty = parseFloat(qtyInput.value);
      const unitPrice = parseFloat(unitPriceInput.value);

      if (!qty || qty <= 0 || !unitPrice || unitPrice < 0) {
        alert("ìˆ˜ëŸ‰ê³¼ ë‹¨ê°€(USD)ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const item = lastCandidates[selectedIndex];
      const rate = parseRate(item.estimated_tariff_rate);
      const totalValueUsd = qty * unitPrice;
      const dutyUsd = totalValueUsd * rate;

      const ratePct =
        item.estimated_tariff_rate ||
        (rate ? (rate * 100).toFixed(2) + "%" : "N/A");

      let resultText =
        `ì˜ˆìƒ ê³¼ì„¸ê°€ê²©: <strong>${formatNumber(totalValueUsd)} USD</strong>` +
        ` Ã— ê´€ì„¸ìœ¨ <strong>${ratePct}</strong> = ` +
        `<strong>${formatNumber(dutyUsd)} USD</strong> (ì˜ˆìƒ ê´€ì„¸)`;

      let totalKrw = null;
      let dutyKrw = null;

      if (usdKrwRate) {
        totalKrw = totalValueUsd * usdKrwRate;
        dutyKrw = dutyUsd * usdKrwRate;
        resultText +=
          `<br />â‰ˆ ê³¼ì„¸ê°€ê²© <strong>${formatNumber(totalKrw)}ì›</strong>` +
          ` / ê´€ì„¸ <strong>${formatNumber(dutyKrw)}ì›</strong>` +
          ` (í™˜ìœ¨ ${usdKrwRate.toFixed(2)}ì›/USD ê¸°ì¤€)`;
      } else {
        resultText +=
          "<br />* í™˜ìœ¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ì›í™” í™˜ì‚°ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }

      dutyResultEl.innerHTML = resultText;

      // ìƒíƒœ ì €ì¥ (ì´í›„ ì´ë©”ì¼ Stepì—ì„œ ì‚¬ìš©)
      lastSelectedIndex = selectedIndex;
      lastDutyCalc = {
        qty,
        unitPrice,
        totalValueUsd,
        dutyUsd,
        ratePct,
        totalKrw,
        dutyKrw,
        usdKrwRate,
      };

      // ê´€ì„¸ ê³„ì‚°ì´ ëë‚˜ë©´ ì´ë©”ì¼ Step ì¹´ë“œ ë…¸ì¶œ + ìŠ¤í¬ë¡¤ ë‹¤ìš´
      emailSection.classList.remove("hidden");
      setTimeout(() => {
        emailSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 180);
      emailPreviewEl.classList.add("hidden");
      emailPreviewEl.innerHTML = "";
      emailSendBtn.classList.add("hidden");
      emailSendStatusEl.classList.add("hidden");
      emailSendStatusEl.textContent = "";
      lastEmailDraft = null;
    });

    // ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í´ë¦­
    emailPreviewBtn.addEventListener("click", async () => {
      if (lastSelectedIndex < 0 || !lastCandidates[lastSelectedIndex]) {
        alert("ë¨¼ì € HTS ì½”ë“œë¥¼ ì„ íƒí•˜ê³  ê´€ì„¸ ê³„ì‚°ê¹Œì§€ ì™„ë£Œí•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (!lastDutyCalc) {
        alert("ê´€ì„¸ ê³„ì‚°ì„ ë¨¼ì € ì™„ë£Œí•´ ì£¼ì„¸ìš”.");
        return;
      }

      const emailTo = (emailToInput.value || "").trim();
      if (!emailTo) {
        alert("ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      // ì•„ì£¼ ê°„ë‹¨í•œ ì´ë©”ì¼ í˜•ì‹ ì²´í¬
      if (!/.+@.+\..+/.test(emailTo)) {
        alert("ì´ë©”ì¼ ì£¼ì†Œ í˜•ì‹ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const productName = document.getElementById("product_name").value;
      const exporterHs = document.getElementById("exporter_hs").value || null;
      const description = document.getElementById("description").value;
      const countryOfOrigin = document.getElementById("country_of_origin").value;

      const selected = lastCandidates[lastSelectedIndex];

      const payload = {
        product_name: productName,
        exporter_hs: exporterHs,
        description: description,
        country_of_origin: countryOfOrigin,

        email_to: emailTo,

        hts_code: selected.hts_code || "",
        hts_title: selected.title || "",
        estimated_tariff_rate: selected.estimated_tariff_rate || "",
        confidence: selected.confidence ?? null,

        qty: lastDutyCalc.qty,
        unit_price: lastDutyCalc.unitPrice,
        total_value_usd: lastDutyCalc.totalValueUsd,
        duty_usd: lastDutyCalc.dutyUsd,

        total_value_krw: lastDutyCalc.totalKrw,
        duty_krw: lastDutyCalc.dutyKrw,
        usd_krw_rate: lastDutyCalc.usdKrwRate,
      };

      emailPreviewEl.classList.remove("hidden");
      emailPreviewEl.innerHTML = "ì´ë©”ì¼ ë‚´ìš©ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...";
      emailSendBtn.classList.add("hidden");
      emailSendStatusEl.classList.add("hidden");
      emailSendStatusEl.textContent = "";
      lastEmailDraft = null;

      try {
        const res = await fetch("http://127.0.0.1:8000/api/preview_email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();

        if (data.error) {
          emailPreviewEl.innerHTML =
            '<div class="error-box">Error: ' + data.error + "</div>";
          return;
        }

        const to = data.to || emailTo;
        const subject = data.subject || "";
        const body = data.body || "";

        emailPreviewEl.innerHTML = `
          <div class="email-preview-header">ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</div>
          <div class="email-preview-meta">
            To: ${to}<br/>
            Subject: ${subject}
          </div>
          <div>${body.replace(/\n/g, "<br />")}</div>
        `;

        // ë§ˆì§€ë§‰ ì´ë©”ì¼ ì´ˆì•ˆ ì €ì¥ (ë°œì†¡ìš©)
        lastEmailDraft = { to, subject, body };
        emailSendBtn.classList.remove("hidden");
        emailSendStatusEl.classList.add("hidden");
        emailSendStatusEl.textContent = "";

        setTimeout(() => {
          emailPreviewEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 120);
      } catch (err) {
        console.error(err);
        emailPreviewEl.innerHTML =
          '<div class="error-box">Error: ' + String(err) + "</div>";
      }
    });

    // ì´ë©”ì¼ ë°œì†¡ ë²„íŠ¼ í´ë¦­
    emailSendBtn.addEventListener("click", async () => {
      if (!lastEmailDraft) {
        alert("ë¨¼ì € ì´ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const accessToken = emailAccessTokenInput.value.trim();
      if (accessToken) {
        localStorage.setItem("EMAIL_ACCESS_TOKEN", accessToken);
      }

      emailSendStatusEl.classList.remove("hidden");
      emailSendStatusEl.textContent = "ì´ë©”ì¼ì„ ë³´ë‚´ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const res = await fetch("http://127.0.0.1:8000/api/send_email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(accessToken ? { "X-Access-Token": accessToken } : {}),
          },
          body: JSON.stringify({
            email_to: lastEmailDraft.to,
            subject: lastEmailDraft.subject,
            body: lastEmailDraft.body,
          }),
        });
        const data = await res.json();
        if (data.error) {
          emailSendStatusEl.textContent =
            "ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error;
        } else {
          emailSendStatusEl.textContent =
            "ì´ë©”ì¼ì„ ë°œì†¡í–ˆì–´ìš”. ë°›ì€ í¸ì§€í•¨ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
        }
      } catch (err) {
        console.error(err);
        emailSendStatusEl.textContent =
          "ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + String(err);
      }
    });
  </script>
</body>
</html>
--